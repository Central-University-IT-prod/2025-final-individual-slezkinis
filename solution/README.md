# Ads_Platform

## Установка и запуск

Приложение упаковано в один большой кластер, состоящий из 5 контейнеров:
1. db - База данных `Postgres`
2. redis - `Redis`. В нём хранится время и другие переменные, нужные для настройки приложения
3. minio - `Minio` - сервер хранения данных. На нём лежат картинки кампаний
4. api - Само API и TG бот
5. grafana - Средство визуализации данных. Тут отображается статистика для владельца рекламной платформы

Для запуска приложения должен быть установлен [Docker](https://www.docker.com/)
1. Сначала собираем приложение командой:
    ``` sh
    docker-compose build
    ```
2. Затем запустить:
    ``` sh
    docker-compose up
    ```

API будет запущено по адесу http://REDACTED:8080/ ; Grafana - http://REDACTED:3000

## Работа приложения

### API
Структура API почти полностью совпадает с исходной, но добавлено нескольлко endpoint-ов:
* Кампании
    * `/advertiser/<advertiser_id>/<campaign_id>/images` Методы: GET и POST
        * GET - получение всех картинок конкретной кампани. Пример ответа: 
            ``` json
            [{"id": 1, "url": "http://REDACTED:8080/media/img.png"}]
            ```
        * POST - загрузка фотографии в кампанию. Нужно передать в `form-data` в поле `file` изображение. Пример, как это сделать с помощью curl:
            ``` sh
            curl -X POST -F "image=@2025-02-04 20.50.31.jpg" http://REDACTED:8080/advertisers/<advertiser_id>/campaigns/<campaign_id>/images
            ```
            Пример ответа:
            ``` json
            {"url": "http://REDACTED:8080/media/img.png"}
            ```
    * `/advertiser/<advertiser_id>/campaign_id>/images/<image_id>` - получение картинки по id. Методы: GET и DELETE
        * GET - получение ссылки на картинку. Пример ответа:
            ``` json
            {"url": "http://REDACTED:8080/media/img.png"}
            ```
        * DELETE - удаление картинки.

    * `/advertiser/<advertiser_id>/generate_text` - генерация текста для кампании с помощью ИИ. Методы: POST
        * POST - генерация текста. Нужно передать поле `ad_title` - название. Также, по желанию, можно указать поле `about_campaign` - краткое описание рекламы для ИИ. Пример ответа:
            ``` json
            {"generated_text": "Крутое ИИ описание"}
            ```
* Настройки цензуры
    * `/censor/status` - получение и изменение состояния цензуры. Методы: GET и POST
        * GET - получение состояния. Пример ответа:
            ``` json
            {"censor_status": false}
            ```
        * POST - изменение статуса. Нужно передать поле `censor_status` со значением `true` - включена проверка, а `false` - выключена.

    * `/censor/words` - получение и изменение списка плохих слов. Методы: GET и POST
        * GET - получение списка. Пример ответа:
            ``` json
            ["плохое_слово_1", "плохое_слово_2"]
            ```
        * POST - изменение списка. Нужно передать в поле`words` со списком плохих слов. Пример ответа:
            ``` json
            ["плохое_слово_1", "плохое_слово_2"]
            ```

* API для Grafana. Во всех этих методах возвращается статистика, поэтому только метод GET.
    * `/graf_stats/clicks_immersive` - получение количества просмотров и переходов за всё время на всех рекламах
    * `clicks_immersive/daily` - то же, что и выше, но по дням
    * `cost_immersive_clicks/daily` - основная информация, такая как конверсия и т.д по всем кампаниям по датам
    * `total_profit` - общая прибыль платформы
    * `total-conversation` - общая конверсия за всё время


### Grafana
Эта часть приложения поможет руководящей части нашей компании следить за прибылью, конверсией и т.д. Она запущена по адресу: `http://REDACTED:3000`
1. Авторизация. При переходе по ссылке нас встречает форма авторизации. Креды по умолчанию: `admin - admin`. <br>
    <!-- ![Авторизация](./imgs/grafana/grafana_login.png) -->
    <img src="./imgs/grafana/grafana_login.png" alt="Авторизация" width="600"/>
2. После успешной авторизации мы попадаем на главный экран с новостями и т.д. <br>
    <img src="./imgs/grafana/grafana_main.png" alt="Новости" width="600"/>
    <br>
    Нам нужно нажать кнопку `Dashboards` и выбрать дашборд с названием `Основная панель статистики` <br>
    <img src="./imgs/grafana/grafana_all_dashboards.png" alt="Дашборды" width="600"/>
3. После выбора дашбоарда нас встречает статистика. Если навести на любую диаграмму, будет написано, что она показывает <br>
    <!-- ![Статистика](./imgs/grafana/grafana_need_dashboard.png) -->
    <img src="./imgs/grafana/grafana_need_dashboard.png" alt="stat" width="600"/>

Вуаля) Поздравляю.

### Телеграм бот
Для удобства рекламодателей был создан [телеграмм бот](https://t.me/prod_ad_platform_bot).

1. После старта бот попросит указать id рекламодателя, чтобы привязать аккаунт телеграмм к аккаунту рекламодателя <br>
    ![ID-рекламодателя](./imgs/tg_bot/set_up_advertiser_id.png)
2. Затем нас встречает главное меню. Нажав на верхнюю кнопку, мы перейдём к нашим рекламным кампания, а по второй откроется обобщённая статистика по всем кампаниям <br>
    ![main-menu](./imgs/tg_bot/main_menu.png)
3. Сейчас нажмём на кнопку со статистикой. Есть два типа статистики: за всё время и разделённая по дням. Можно выбрать любую <br>
    ![advertiser-stat](./imgs/tg_bot/advertiser_stat.png)
4. Вернувшись назад и перейдя к кампаниям, можно увидеть все наши кампании. Но для начала нужно их создать. Нажимаем кнопку `Cоздать кампанию` <br>
5. Есть два способа загрузить рекламу: через .json файл и через сам телеграмм. Там всё интуитивно понятно, можно выбрать тот способ, который удобен. <br>
    ![methods-create-campaign](./imgs/tg_bot/create_campaign.png)
6. После создания кампании можно просмотреть её данные, нажав в главном меню Кампании > Название кампании. Показывается основная информация о рекламе и методы взаимодействия с ней.  <br>
    <!-- ![campaign_info](./imgs/tg_bot/campaign_info.png) -->
    <img src="./imgs/tg_bot/campaign_info.png" alt="campaign_info" width="600"/>
7. Все методы достаточно понятны, поэтому я покажу один из них - Статистика. Нажав на эту кнопку, выпадает меню с выбором получаемой статистики. Тут всё также, как в п. 3.


Ну всё, это была быстрая экскурсия по боту. Удачной работы




# Блок-схема базы данных
![Блок-схема бд](./imgs/bd_schema.png)

Сейчас подробно расскажу про каждую таблицу:
* MLScore - здесь хранится значение мл_скора между клиентом и рекламодателем
* View - здесь хранятся просмотры. Когда пользователь посмотрел рекламу, сюда добавляется запись
* Click - сохраняются все клики клиента на рекламу
* CampaignImage - тут хранятся картинки для реклам
* TgUser - здесь хранятся ChatID пользователей в телеграмме и сохранятся связь между advertiser и пользователем телеграмма
* Client - здесь хранятся пользователи
* Campaign - сами рекламы
* Advertiser - рекламодатели


# Принцип работы алгоритма подбора рекламы

Мой алгоритм выбирает рекламу таким образом, чтобы количество "очков" у предложения было выше. А баллы, в свою очередь, считаются по следующей формуле:<br>
`0.6 * (campaign.cost_per_impression if not viewed else 0) + 0.6 * (campaign.cost_per_click if not clicked else 0) + 0.1 * ml_score + 0.2 * (max([campaign.cost_per_impression, campaign.cost_per_click]) if count_view / campaign.impressions_limit < 0.7 else 0)`

Т.к для нашей компании самое важное - это прибыль, то в итоговой формуле она имеет наибольший вес. Затем идёт релевантность рекламы, чтобы пользователю была интересна просматриваемая реклама. За счёт формулы учитываются случаи, когда реклама менее релевантная, но при этом более высокооплачиваемая. 
Вначале программа фильтрует рекламы и оставляет только те, которые активны в данный момент и подходят по таргетингу. Потом считаются очки по вышеуказанной формуле. Чем больше, тем лучше. И потом берётся реклама с максимальным значением и показывается пользователю
Эта блок-схема более точно покажет логику работы: <br>
![Блок-схема алгоритма](./imgs/algotithm.png)


# Выбор стека

1. PostgreSQL - одна из самых популярных и надёжных СуБД. Отличается своей скоростью и удобностью развёртывания в Docker
2. Django - популярный фреймворк на Python. Удобен своей ORM и скоростью написания приложения. Не отличается скоростью, но т.к. у нас небольшая компания, то его хватит
3. DRF - используется для создания API. За счёт своей серилизации данных помогает лучше валидировать данные и контролировать доступ. Достаточно популярен
4. pyTelegramBotAPI - библиотека для создания ТГ ботов. Т.к наш телеграм бот используется как времменная замена фронтенда, то нет смысла разворачивать aiogram, telebot-а будет достаточно
5. Minio - удобное, популярное, open-source файловое хранилище. Большим плюсом является возможность развернуть его в Docker и удоьно подключить к Django через одноимённую библиотеку.
6. Grafana - один из немногих визуализаторов данных. Красивый дизайн, лёгкий старт и запуск, возможность развернуть в Docker


# Тестирование

Для запуска тестов нужно установить все зависимости командой:
``` sh
pip3 install -r ad_platform/requirements.txt
```

Потом перейти в каталог:
``` sh
cd ad_platform
```
Затем экспортировать переменные окружения:
``` sh
export DJANGO_SETTINGS_MODULE=ad_platform.settings.test
```

И провести миграции в БД:
``` sh
python3 manage.py migrate
```

А потом запустить тесты командой:
``` sh
py.test
```
Будут запущены все тесты. Чтобы запустиь тесты выборочно можно указать до них путь:
``` sh
py.test ad_platform/tests/test_01_clients.tavern.yml
```

Важно!! Для e2e тестов не забудьте запустить API на порту 8080!